% !TEX root = ../Rulebook.tex
\label{sec:Competition}

The competition is held in the form of so called tests.
A test requires a robot to perform various abilities, including navigation, manipulation, task planning and autonomous decision making.
Different kinds of tests each have their focus a current research field, e.g. picking moving objects or efficient task execution.

All tests require a robot to autonomously navigate the arena defined in \ref{sec:ArenaDesign} without causing a collision. Each team can enter the arena before actual competitions to create a map of the environment and test their robot. The OC will organize time slots for each team respecting the amount of teams and available slots. Usually there will be some setup days that can be used only for training.

\section{Time Schedule}

The actual competition currently includes a total of 7 tests.
These are spread across available competition days, with test having time buffers in between each other.
An example for the schedule can be found here: \url{https://atwork.robocup.org/rc2021/}.
As on site events have tighter schedules and additionally require teams to prepare everything for an unknown environment, there will usually only be two setup and four competition days, maybe even less.
Teams should prepare for something like fig. \ref{fig:example_schedule}. 

\begin{figure}[h!]
\centering
\includegraphics[width= 0.8\textwidth ]{./images/competition/example_schedule}
\caption{Example of a time schedule for a \RCAW competition.}
\label{fig:example_schedule}
\end{figure}

Team leaders are required to announce wether their team likes to participate in a test 1 hour prior to the start time to allow the OC to plan the schedule and create scoring sheets.

\section{Parc ferm\'e}

All participating teams must bring their performing robot to the parc ferm\'e 15 minutes before a test and leave them there during the whole timeslot of the test, except when they must perform.
Rules similar to motorsports apply: The robot must not be worked on or changed in any kind unless
serious damage must be repaired. This intends to encourage teams to watch other performances while still give teams the chance to remain in the competition. It is allowed to attach a charger to the robot.

The location of the parc ferm\'e will be towards the spectators for entertainment.
The robots may (are wished to) be turned on and ready to perform, enabling teams to set robot arm positions and illumination for the visitors. 

If the power management of a robot does not enable it to be turned on during the runs of other teams,
the specific team may power-on and boot their robot once the run of the previous team has ended.
They may not change or modify their robot in any way during this time (hardware and software).

\section{Test Procedure}

15 minutes before a competition slot the arena is set up for the upcoming test.
Therefore, the position of each static arena element is checked and objects are placed on active 
Service Areas.
The TC will decide where dynamic arena elements are placed 
and which orientation an object gets to create a starting setup for the test.
\lucas{TC or referees decide dynamic elements and only orientation?} 

Each team must nominate one person which acts as a referee during all tests.
The job of each ref is to ensure that the arena state before each performance is the same as the setup.
They also rate each performance. This ensures that the interests of every team are respected equally.

A performance slot for a team includes a preparation phase, the run phase and the end phase.

\textbf{Preparation Phase}

During the prep phase, teams are allowed to move their robot from the parc ferm\'e to the defined start pose in the arena either by hand or by carefully driving manually. They should prepare their robot for their run and can therefore remote access the robot and/or make minor changes.
It is explicitly forbidden to hardcode solutions for specific requirements of a test during this phase (e.g. drawing position of obstacles in the map). Also, if the robot passes and detects obstacles during this phase, they must be erased from the memory (e.g. clear costmap) unless they can be detected from the START location.

\textbf{Run Phase}

The run phase begins once the start time is up or when the teamleader announces that the team is ready. 
The task is then sent to the robot and from there on, the robot must act fully autonomously. It is forbidden to interact or control the robot in any human kind (keyboard/mouse actions, gestures, voice). The unplugging of a LAN cable to ensure that the task was send to the robot at bad WLAN connections is the only interaction with the robot that is allowed.
The run phase ends once the robot has stopped at the FINISH location of the arena, when the run time is up, when the teamleader says 'stop' or the robot caused a second Major Collision.

\textbf{End Phase}

In the resulting end phase the team is expected to move their robot back to parc ferm\'e.
Referees gather and discuss their performance rating afterwards.
Once they agree on the performing team's result, 
the teamleader is required to accept this score. 
Teams are allowed to make their case if they do not agree with the refs decision,
but cannot force changes and are expected to be understanding.
Special cases will be decided by the TC if the rulebook leaves room for interpretation.

Once the score has been accepted by a team,
the arena must be set up for the next run if necessary.
The prep time of the next team begins once the arena state is declared as ready by all refs.

TODO ADD TABLE 

\section{Skipping Tests}

If a team decides not to participate in a test during the official time slot, this test type may be repeated once during a following time slot. This should enable struggling teams to do the more simpler tests later in the competition. This option should only be used by teams if really necessary to keep the structure of the overall competition. Also, teams are only allowed to perform a test with a lower potential total score than the current test.



\section{Referee box}
\label{sec:atwork-commander}
\marco{todo: finally move this, chapter 4?}
\martin{Refbox != atwork-commander, 
\begin{itemize}
	\item  Refbox==Physical Computer, Timer, TV screen, desk for TC and referees,...
	\item atwork-commander, software to produce a random test procedure, 
	\item here also the procedure with bagfiles could be explained
\end{itemize}} 

The TC shall provide a referee box that supports the evaluation of the competition. It applies the time measuring, generates the tasks according to the chosen test configuration and monitors the competition. For this purpose each robot has to transmit a keep-alive signal every second during all phases (initialization, preparation, game, finish).

The referee box
\begin{enumerate}
	\item announces the start of the preparation time,
	\item communicates the task specifications,
	\item starts each competition run, and
	\item closes a successful run after reaching the endzone, or
	\item aborts the run in case of a time lapse (indicated by a sound signal of the atWork-commander).
\end{enumerate}

% Figure \ref{fig:refbox} depicts the progress of a competition run.
When the robot is initialized, it starts immediately to transmit its beacon
signal. The referee box answers with a state information. If the previous robot
has left the arena, one of the referees starts the seconded phase by pushing a
button. The referee box transmits a new state message that informs the robot
about the beginning of the initialization phase. Inside the referee box a
timer is started which initiates the start of the execution phase after
transmitting the test parameters. During the run the robot is able to activate
the external devices and to receive their status information. This run phase is
terminated by a second timer that alerts after the duration defined in the
instance table.
%
% \begin{figure}
% \centering
% \input{./tikz/sequence.tikz}
% \caption{Sequence diagram of a complete competition run monitored by the referee box}
% \label{fig:refbox}
% \end{figure}
% \par
The TC provides a \aterm{Robot Operating System}{ROS} based interface of the referee box as well as
a reference implementation.
The Referee box implementation and its documentation is available under the following link:
\begin{center}
	\url{https://github.com/robocup-at-work/atwork-commander}
	
\end{center}



% The publish/subscribe communication with the referee box and the external
% devices have to be mapped on the following topics:\note{We should not talk about @Work being a game, e.g. "gamestate". (Sven and Fred)}

% \begin{table}[h!]
% \centering
%  \begin{tabular}{|l|c|c|p{5.9cm}|}
%  \hline
%  Topic & Robot & Refbox & Remarks \\ \hline\hline
%  {\tt /atwork/refbox/gamestate} & S & P & {\tt uint8 gamestate \newline
% uint8 PREPERATION  = 0\newline
% uint8 RUNNING\_TASK = 1\newline
% uint8 PAUSE    = 2  \newline
% uint8 END\_TASK     = 3\newline
% uint8 STOP     = 4 }\\ \hline
%   {\tt /atwork/refbox/beacon} & P & S & {\tt
%   geometry\_msgs/Pose2D position \newline
% string  current\_action } \\ \hline
%    {\tt /atwork/refbox/taskinfo } & S & P & {\tt BNT[] bnt\_tasks \newline
% BMT[] bmt\_tasks  \newline
% BTT[] btt\_tasks } \\ \hline
%    {\tt /atwork/refbox/[device]/command} & P & S & {\tt int8 state \newline
% int8 ERROR        = -1 \newline
% int8 NOT\_RUNNING  = 0 \newline
% int8 RUNNING      = 1   }\\\hline
%    {\tt /atwork/refbox/[device]/status  } & S & P & {\tt int8 state \newline
% int8 ERROR        = -1 \newline
% int8 NOT\_RUNNING  = 0 \newline
% int8 RUNNING      = 1   }\\\hline
%  \end{tabular}
%   \label{tab:RefBoxTopics}
%  \caption{Referee box topics}
% \end{table}
%
% \begin{table}[h!]
% \centering
%  \begin{tabular}{|l|p{6.3cm}|}
%  \hline
%  Message types & Remarks \\ \hline\hline
%  {\tt Atworkobject} & {\tt uint8 name\newline
% uint8 F20\_20\_B = 0 \newline
% uint8 F20\_20\_G = 1 \newline
% uint8 S40\_40\_B = 2 \newline
% uint8 S40\_40\_G = 3 \newline
% uint8 M20\_100  = 4 \newline
% uint8 M20      = 5 \newline
% uint8 M30      = 6 \newline
% uint8 R20      = 7 \newline
% \revdel{uint8 V20      = 8} \newline
% string destination }\\ \hline
%
%  {\tt BNT} &  {\tt Waypoint[] waypoints }\\ \hline
%
%  {\tt BMT} &  {\tt string   startplace \newline
% string[] pickObjects \newline
% string   destination }\\ \hline
%
%   {\tt BTT} &  {\tt string destination  \newline
% AtworkObject[] objects }\\ \hline
%    {\tt Waypoint  } &  {\tt string position \newline
% uint8  orientation \newline
% uint8  WEST  = 0 \newline
% uint8  EAST  = 1 \newline
% uint8  SOUTH = 2 \newline
% uint8  NORTH = 3 \newline
% uint32  duration  }\\\hline
%  \end{tabular}
%  \caption{Refere box auxiliary message types \todo{can we provide a repository where the message files are stored? And make it consistent with items in Table \ref{tab:manipulation_objects} and \ref{tab:manipulation_objects_rockin}. And add the missing test like PPT, CBT, etc.}}
%   \label{tab:RefBoxAUX}
% \end{table}
%
% Table~\ref{tab:RefBoxAUX} summarizes the auxiliary types embedded in
% the referee box messages. A detailed description of the referee box-API is given in the
% corresponding documentation available on \todo{???????????????}.

\par
The referee box visualizes the current state of the competition run, time measurements, the task specification and robot positions for visitors. Team information (name, affiliation, contact information) are given too in this context.


